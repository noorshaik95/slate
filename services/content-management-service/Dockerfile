# Multi-stage build for content-management-service
# Stage 1: Builder
FROM rust:latest as builder

# Install protobuf compiler
RUN apt-get update && apt-get install -y protobuf-compiler && rm -rf /var/lib/apt/lists/*

WORKDIR /build

# Copy proto files to match build.rs expectations
COPY proto /build/proto

# Set up the service directory structure
WORKDIR /build/services/content-management-service

# Copy the content-management-service files
COPY services/content-management-service/Cargo.toml ./
COPY services/content-management-service/build.rs ./
COPY services/content-management-service/src ./src
COPY services/content-management-service/migrations ./migrations

# Build the application
RUN cargo build --release

# Stage 2: Runtime
FROM debian:sid-slim

# Install runtime dependencies
RUN apt-get update && apt-get install -y \
    ca-certificates \
    ffmpeg \
    libssl3 \
    libpq5 \
    && rm -rf /var/lib/apt/lists/*

# Create non-root user for security
RUN useradd -m -u 1000 cms && \
    mkdir -p /app && \
    chown -R cms:cms /app

WORKDIR /app

# Copy compiled binary from builder
COPY --from=builder /build/services/content-management-service/target/release/content-management-service /usr/local/bin/content-management-service

# Switch to non-root user
USER cms

# Expose ports
# 50052: gRPC service
# 8082: HTTP health check
# 9092: Prometheus metrics
EXPOSE 50052 8082 9092

# Run the service
CMD ["content-management-service"]
