version: '3.8'

name: slate

services:
  # PostgreSQL Database for User Auth Service
  postgres:
    image: postgres:15-alpine
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: userauth
    ports:
      - "5432:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M

  # Redis for Rate Limiting
  redis:
    image: redis:7-alpine
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.25'
          memory: 128M
    restart: unless-stopped

  # User Auth Service (Go)
  user-auth-service:
    build:
      context: .
      dockerfile: services/user-auth-service/Dockerfile
    environment:
      SERVER_HOST: "0.0.0.0"
      SERVER_PORT: "8081"
      DB_HOST: "postgres"
      DB_PORT: "5432"
      DB_USER: "postgres"
      DB_PASSWORD: "postgres"
      DB_NAME: "userauth"
      DB_SSLMODE: "disable"
      JWT_SECRET: "your-super-secret-jwt-key-change-in-production"
      JWT_ACCESS_TOKEN_DURATION: "15"
      JWT_REFRESH_TOKEN_DURATION: "168"
      GRPC_HOST: "0.0.0.0"
      GRPC_PORT: "50051"
      OTEL_EXPORTER_OTLP_ENDPOINT: "tempo:4317"
      REDIS_HOST: "redis"
      REDIS_PORT: "6379"
      RATE_LIMIT_ENABLED: "true"
      RATE_LIMIT_LOGIN_MAX: "5"
      RATE_LIMIT_LOGIN_WINDOW: "900"
      RATE_LIMIT_REGISTER_MAX: "3"
      RATE_LIMIT_REGISTER_WINDOW: "3600"
      # Database Connection Pool Configuration
      DB_MAX_OPEN_CONNS: "25"           # Maximum number of open connections
      DB_MAX_IDLE_CONNS: "5"            # Maximum number of idle connections
      DB_CONN_MAX_LIFETIME: "5m"        # Maximum lifetime of a connection
      DB_CONN_MAX_IDLE_TIME: "1m"       # Maximum idle time before closing
      # Logging Configuration
      LOG_LEVEL: "info"                 # Log level: debug, info, warn, error
      # Environment Configuration
      ENVIRONMENT: "development"        # Environment: development, production (affects JWT secret validation)
    ports:
      - "50051:50051"
      - "8081:8081"
      - "9091:9090"  # Prometheus metrics endpoint
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      tempo:
        condition: service_started
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.25'
          memory: 128M
    restart: unless-stopped

  # Tenant Service (Go) - Epic 9: US-9.1 Tenant Provisioning
  tenant-service:
    build:
      context: .
      dockerfile: services/tenant-service/Dockerfile
    environment:
      SERVER_HOST: "0.0.0.0"
      SERVER_PORT: "8083"
      DB_HOST: "postgres"
      DB_PORT: "5432"
      DB_USER: "postgres"
      DB_PASSWORD: "postgres"
      DB_NAME: "tenantdb"
      DB_SSLMODE: "disable"
      GRPC_HOST: "0.0.0.0"
      GRPC_PORT: "50053"
      OTEL_EXPORTER_OTLP_ENDPOINT: "tempo:4317"
      REDIS_HOST: "redis"
      REDIS_PORT: "6379"
      USER_SERVICE_URL: "user-auth-service:50051"
      EMAIL_SERVICE_URL: "email-service:50052"
      EMAIL_ENABLED: "true"
      WELCOME_EMAIL_DELAY_SECONDS: "5"
      BASE_SETUP_URL: "http://localhost:8080"
      LOG_LEVEL: "info"
      ENVIRONMENT: "development"
    ports:
      - "50053:50053"
      - "8083:8083"
      - "9093:9090"  # Prometheus metrics endpoint
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      tempo:
        condition: service_started
      user-auth-service:
        condition: service_started
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.25'
          memory: 128M
    restart: unless-stopped

  # Email Service (Go) - Epic 9: AC4 Welcome email
  email-service:
    build:
      context: .
      dockerfile: services/email-service/Dockerfile
    environment:
      SERVER_HOST: "0.0.0.0"
      SERVER_PORT: "8082"
      DB_HOST: "postgres"
      DB_PORT: "5432"
      DB_USER: "postgres"
      DB_PASSWORD: "postgres"
      DB_NAME: "emaildb"
      DB_SSLMODE: "disable"
      GRPC_HOST: "0.0.0.0"
      GRPC_PORT: "50052"
      OTEL_EXPORTER_OTLP_ENDPOINT: "tempo:4317"
      SMTP_HOST: "mailhog"
      SMTP_PORT: "1025"
      SMTP_USERNAME: ""
      SMTP_PASSWORD: ""
      SMTP_FROM_EMAIL: "noreply@slate.local"
      SMTP_FROM_NAME: "Slate Platform"
      LOG_LEVEL: "info"
      ENVIRONMENT: "development"
    ports:
      - "50052:50052"
      - "8082:8082"
      - "9092:9090"  # Prometheus metrics endpoint
    depends_on:
      postgres:
        condition: service_healthy
      tempo:
        condition: service_started
      mailhog:
        condition: service_started
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.25'
          memory: 128M
    restart: unless-stopped

  # Metrics Service (Go) - Epic 9: US-9.2 Usage Metrics Dashboard
  metrics-service:
    build:
      context: .
      dockerfile: services/metrics-service/Dockerfile
    environment:
      SERVER_HOST: "0.0.0.0"
      SERVER_PORT: "8084"
      DB_HOST: "postgres"
      DB_PORT: "5432"
      DB_USER: "postgres"
      DB_PASSWORD: "postgres"
      DB_NAME: "metricsdb"
      DB_SSLMODE: "disable"
      GRPC_HOST: "0.0.0.0"
      GRPC_PORT: "50054"
      OTEL_EXPORTER_OTLP_ENDPOINT: "tempo:4317"
      PROMETHEUS_URL: "http://prometheus:9090"
      METRICS_UPDATE_INTERVAL: "30"  # AC6: Update every 30 seconds
      ERROR_RATE_THRESHOLD: "1.0"    # AC7: Alert if error rate > 1%
      UPTIME_THRESHOLD: "99.5"       # AC7: Alert if uptime < 99.5%
      LOG_LEVEL: "info"
      ENVIRONMENT: "development"
    ports:
      - "50054:50054"
      - "8084:8084"
      - "9094:9090"  # Prometheus metrics endpoint
    depends_on:
      postgres:
        condition: service_healthy
      prometheus:
        condition: service_started
      tempo:
        condition: service_started
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M
    restart: unless-stopped

  # MailHog for Email Testing (Development Only)
  mailhog:
    image: mailhog/mailhog:latest
    ports:
      - "1025:1025"  # SMTP server
      - "8025:8025"  # Web UI
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 128M
        reservations:
          cpus: '0.1'
          memory: 64M
    restart: unless-stopped

  # API Gateway (Rust/Axum)
  api-gateway:
    build:
      context: .
      dockerfile: services/api-gateway/Dockerfile
    environment:
      # Logging configuration - supports per-module levels
      # Examples: "info", "debug", "info,api_gateway=debug,tower_http=warn"
      RUST_LOG: "info"
      GATEWAY_SERVER_HOST: "0.0.0.0"
      GATEWAY_SERVER_PORT: "8080"
      GATEWAY_AUTH_SERVICE_ENDPOINT: "http://user-auth-service:50051"
      GATEWAY_OBSERVABILITY_TEMPO_ENDPOINT: "http://tempo:4317"
      # Request body size limits (DoS prevention)
      MAX_REQUEST_BODY_SIZE: "1048576"      # 1MB default limit
      MAX_UPLOAD_BODY_SIZE: "10485760"      # 10MB for upload endpoints
      UPLOAD_PATHS: "/upload,/api/upload"   # Comma-separated paths for upload limit
      # Trusted proxies for X-Forwarded-For header (comma-separated IPs)
      # TRUSTED_PROXIES: "10.0.0.1,172.17.0.1"  # Uncomment and set for production
    ports:
      - "8080:8080"
    volumes:
      - ./config/gateway-config.docker.yaml:/app/config/gateway-config.yaml
    depends_on:
      - prometheus
      - tempo
      - loki
      - grafana
      - user-auth-service
      - tenant-service
      - email-service
      - metrics-service
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M
    restart: unless-stopped

  # Observability Stack
  prometheus:
    image: prom/prometheus
    volumes:
      - ./config/prometheus.yml:/etc/prometheus/prometheus.yml
    ports:
      - "9090:9090"
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M
    restart: unless-stopped

  tempo:
    image: grafana/tempo:latest
    command: [ "-config.file=/etc/tempo/tempo.yaml" ]
    volumes:
      - ./config/tempo.yaml:/etc/tempo/tempo.yaml
    ports:
      - "14268:14268"  # jaeger ingest
      - "3200:3200"   # tempo
      - "4317:4317"   # otlp grpc
      - "4318:4318"   # otlp http
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M
    restart: unless-stopped

  loki:
    image: grafana/loki:2.8.2
    command: "-config.file=/etc/loki/local-config.yaml"
    volumes:
      - ./config/loki.yaml:/etc/loki/local-config.yaml
      - loki-data:/loki
    ports:
      - "3100:3100"
    user: "root"
    environment:
      - PUID=1000
      - PGID=1000
    entrypoint:
      - sh
      - -c
      - |
        mkdir -p /loki/chunks /loki/index /loki/boltdb-cache /loki/compactor /loki/rules
        chown -R loki:loki /loki
        exec /usr/bin/loki -config.file=/etc/loki/local-config.yaml
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M
    restart: unless-stopped

  grafana:
    image: grafana/grafana:latest
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_AUTH_ANONYMOUS_ENABLED=true
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Admin
    volumes:
      - ./config/grafana-datasources.yaml:/etc/grafana/provisioning/datasources/datasources.yaml
    ports:
      - "3000:3000"
    depends_on:
      - prometheus
      - tempo
      - loki
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.25'
          memory: 128M
    restart: unless-stopped

  promtail:
    image: grafana/promtail:2.8.2
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - /var/log:/var/log:ro
      - ./config/promtail-config.yaml:/etc/promtail/promtail-config.yaml
    command: -config.file=/etc/promtail/promtail-config.yaml
    depends_on:
      - loki
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 128M
        reservations:
          cpus: '0.1'
          memory: 64M
    restart: unless-stopped

volumes:
  postgres-data:
    driver: local
  redis-data:
    driver: local
  loki-data:
    driver: local
