version: '3.8'

name: slate

services:
  # PostgreSQL Database for User Auth Service
  postgres:
    image: postgres:15-alpine
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: userauth
    ports:
      - "5432:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M

  # PostgreSQL Database for Content Management Service
  postgres-cms:
    image: postgres:15-alpine
    environment:
      POSTGRES_USER: cms
      POSTGRES_PASSWORD: cms_password
      POSTGRES_DB: cms
    ports:
      - "5433:5432"
    volumes:
      - postgres-cms-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U cms"]
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M

  # Redis for Rate Limiting and Job Queue
  redis:
    image: redis:7-alpine
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.25'
          memory: 128M
    restart: unless-stopped

  # MinIO for S3-compatible object storage
  minio:
    image: minio/minio:latest
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - minio-data:/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M
    restart: unless-stopped

  # ElasticSearch for content search
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.11.0
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
    ports:
      - "9200:9200"
    volumes:
      - elasticsearch-data:/usr/share/elasticsearch/data
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:9200/_cluster/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M
    restart: unless-stopped

  # User Auth Service (Go)
  user-auth-service:
    build:
      context: .
      dockerfile: services/user-auth-service/Dockerfile
    environment:
      SERVER_HOST: "0.0.0.0"
      SERVER_PORT: "8081"
      DB_HOST: "postgres"
      DB_PORT: "5432"
      DB_USER: "postgres"
      DB_PASSWORD: "postgres"
      DB_NAME: "userauth"
      DB_SSLMODE: "disable"
      JWT_SECRET: "your-super-secret-jwt-key-change-in-production"
      JWT_ACCESS_TOKEN_DURATION: "15"
      JWT_REFRESH_TOKEN_DURATION: "168"
      GRPC_HOST: "0.0.0.0"
      GRPC_PORT: "50051"
      OTEL_EXPORTER_OTLP_ENDPOINT: "tempo:4317"
      REDIS_HOST: "redis"
      REDIS_PORT: "6379"
      RATE_LIMIT_ENABLED: "true"
      RATE_LIMIT_LOGIN_MAX: "5"
      RATE_LIMIT_LOGIN_WINDOW: "900"
      RATE_LIMIT_REGISTER_MAX: "3"
      RATE_LIMIT_REGISTER_WINDOW: "3600"
      # Database Connection Pool Configuration
      DB_MAX_OPEN_CONNS: "25"           # Maximum number of open connections
      DB_MAX_IDLE_CONNS: "5"            # Maximum number of idle connections
      DB_CONN_MAX_LIFETIME: "5m"        # Maximum lifetime of a connection
      DB_CONN_MAX_IDLE_TIME: "1m"       # Maximum idle time before closing
      # Logging Configuration
      LOG_LEVEL: "info"                 # Log level: debug, info, warn, error
      # Environment Configuration
      ENVIRONMENT: "development"        # Environment: development, production (affects JWT secret validation)
    ports:
      - "50051:50051"
      - "8081:8081"
      - "9091:9090"  # Prometheus metrics endpoint
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      tempo:
        condition: service_started
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.25'
          memory: 128M
    restart: unless-stopped

  # Content Management Service (Rust)
  content-management-service:
    build:
      context: .
      dockerfile: services/content-management-service/Dockerfile
    environment:
      # Server Configuration
      SERVER__HOST: "0.0.0.0"
      SERVER__PORT: "8082"
      SERVER__GRPC_PORT: "50052"
      SERVER__METRICS_PORT: "9092"
      # Database Configuration
      DATABASE__URL: "postgresql://cms:cms_password@postgres-cms:5432/cms"
      DATABASE__MAX_CONNECTIONS: "20"
      DATABASE__MIN_CONNECTIONS: "5"
      # S3/MinIO Configuration
      S3__ENDPOINT: "http://minio:9000"
      S3__ACCESS_KEY: "minioadmin"
      S3__SECRET_KEY: "minioadmin"
      S3__BUCKET: "content-storage"
      S3__REGION: "us-east-1"
      # ElasticSearch Configuration
      ELASTICSEARCH__URL: "http://elasticsearch:9200"
      ELASTICSEARCH__INDEX: "content"
      # Redis Configuration
      REDIS__URL: "redis://redis:6379"
      REDIS__QUEUE_NAME: "transcoding_jobs"
      # Observability Configuration
      OBSERVABILITY__OTLP_ENDPOINT: "http://tempo:4317"
      OBSERVABILITY__SERVICE_NAME: "content-management-service"
      RUST_LOG: "info"
      # Analytics Service (placeholder - will be implemented later)
      # ANALYTICS_SERVICE_URL: "http://analytics-service:50053"
    ports:
      - "50052:50052"
      - "8082:8082"
      - "9092:9092"
    depends_on:
      postgres-cms:
        condition: service_healthy
      minio:
        condition: service_healthy
      elasticsearch:
        condition: service_healthy
      redis:
        condition: service_healthy
      tempo:
        condition: service_started
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M
    restart: unless-stopped

  # API Gateway (Rust/Axum)
  api-gateway:
    build:
      context: .
      dockerfile: services/api-gateway/Dockerfile
    environment:
      # Logging configuration - supports per-module levels
      # Examples: "info", "debug", "info,api_gateway=debug,tower_http=warn"
      RUST_LOG: "info"
      GATEWAY_SERVER_HOST: "0.0.0.0"
      GATEWAY_SERVER_PORT: "8080"
      GATEWAY_AUTH_SERVICE_ENDPOINT: "http://user-auth-service:50051"
      GATEWAY_OBSERVABILITY_TEMPO_ENDPOINT: "http://tempo:4317"
      # Request body size limits (DoS prevention)
      MAX_REQUEST_BODY_SIZE: "1048576"      # 1MB default limit
      MAX_UPLOAD_BODY_SIZE: "10485760"      # 10MB for upload endpoints
      UPLOAD_PATHS: "/upload,/api/upload,/api/content/upload/chunk"   # Comma-separated paths for upload limit
      # Trusted proxies for X-Forwarded-For header (comma-separated IPs)
      # TRUSTED_PROXIES: "10.0.0.1,172.17.0.1"  # Uncomment and set for production
    ports:
      - "8080:8080"
    volumes:
      - ./config/gateway-config.docker.yaml:/app/config/gateway-config.yaml
    depends_on:
      - prometheus
      - tempo
      - loki
      - grafana
      - user-auth-service
      - content-management-service
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M
    restart: unless-stopped

  # Observability Stack
  prometheus:
    image: prom/prometheus
    volumes:
      - ./config/prometheus.yml:/etc/prometheus/prometheus.yml
    ports:
      - "9090:9090"
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M
    restart: unless-stopped

  tempo:
    image: grafana/tempo:latest
    command: [ "-config.file=/etc/tempo/tempo.yaml" ]
    volumes:
      - ./config/tempo.yaml:/etc/tempo/tempo.yaml
    ports:
      - "14268:14268"  # jaeger ingest
      - "3200:3200"   # tempo
      - "4317:4317"   # otlp grpc
      - "4318:4318"   # otlp http
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M
    restart: unless-stopped

  loki:
    image: grafana/loki:2.8.2
    command: "-config.file=/etc/loki/local-config.yaml"
    volumes:
      - ./config/loki.yaml:/etc/loki/local-config.yaml
      - loki-data:/loki
    ports:
      - "3100:3100"
    user: "root"
    environment:
      - PUID=1000
      - PGID=1000
    entrypoint:
      - sh
      - -c
      - |
        mkdir -p /loki/chunks /loki/index /loki/boltdb-cache /loki/compactor /loki/rules
        chown -R loki:loki /loki
        exec /usr/bin/loki -config.file=/etc/loki/local-config.yaml
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M
    restart: unless-stopped

  grafana:
    image: grafana/grafana:latest
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_AUTH_ANONYMOUS_ENABLED=true
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Admin
    volumes:
      - ./config/grafana-datasources.yaml:/etc/grafana/provisioning/datasources/datasources.yaml
    ports:
      - "3000:3000"
    depends_on:
      - prometheus
      - tempo
      - loki
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.25'
          memory: 128M
    restart: unless-stopped

  promtail:
    image: grafana/promtail:2.8.2
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - /var/log:/var/log:ro
      - ./config/promtail-config.yaml:/etc/promtail/promtail-config.yaml
    command: -config.file=/etc/promtail/promtail-config.yaml
    depends_on:
      - loki
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 128M
        reservations:
          cpus: '0.1'
          memory: 64M
    restart: unless-stopped

volumes:
  postgres-data:
    driver: local
  postgres-cms-data:
    driver: local
  redis-data:
    driver: local
  minio-data:
    driver: local
  elasticsearch-data:
    driver: local
  loki-data:
    driver: local
